/*! $FileVersion=1.1.224 */ var transport_event_hub_fileVersion = "1.1.224"; 
function CreateEventHubTransport(){LoadScript("sha256.js");function b(f,d,g){try{return f.replace(d,g)}catch(h){logError("updateStringWithReplacement: Exception caught with message: "+h.message);return f}}function a(){this._apiVersion=null;this._servicebusNamespace=null;this._eventHubPath=null;this._sharedAccessKey=null;this._sharedAccessName=null;this._sharedAccessToken=null;this._tokenCreationTime=null;this._timeout=60;this._url="https://{servicebusNamespace}.servicebus.windows.net/{eventHubPath}/messages?timeout={timeout}&api-version={apiVersion}"}a.prototype=ModuleManager.create("rest_transport");a.prototype.constructor=a;a.prototype._setup=function(){this._apiVersion=this._config.apiVersion;if(!this._apiVersion){logError("Event_Hub_Transport:: Initialize Invalid (unspecified) _apiVersion");return false}this._servicebusNamespace=this._config.servicebusNamespace;if(!this._servicebusNamespace){logError("Event_Hub_Transport:: Initialize Invalid (unspecified) _servicebusNamespace");return false}this._eventHubPath=this._config.eventHubPath;if(!this._eventHubPath){logError("Event_Hub_Transport:: Initialize Invalid (unspecified) _eventHubPath");return false}this._sharedAccessKey=this._config.sharedAccessKey;if(!this._sharedAccessKey){logError("Event_Hub_Transport:: Initialize Invalid (unspecified) sharedAccessKey");return false}this._sharedAccessName=this._config.sharedAccessName;if(!this._sharedAccessName){logError("Event_Hub_Transport:: Initialize Invalid (unspecified) sharedAccessName");return false}this._tokenRefreshTime=this._config.tokenRefreshTime;if(!this._tokenRefreshTime){this._tokenRefreshTime=1}this._updateURL("{servicebusNamespace}",this._servicebusNamespace);this._updateURL("{eventHubPath}",this._eventHubPath);this._updateURL("{timeout}",this._timeout);this._updateURL("{apiVersion}",this._apiVersion);this._createRESTclientPlugin();if(this.GetVersion()&&(this.GetVersion()!="1")&&(this.GetVersion()!="2")){this._usingRESTclientPlugin=true;logInformation("Calling parent class to setup using the restful plugin");this._plugin.SetHttpMode("POST");var d=getSystemPlugin();this._plugin.SetAgentName("McAfee EventHub transmitter_"+d.CreateGUID());this._plugin.Connect(this._url)}else{this._plugin=null}return true};a.prototype._updateURL=function(d,e){this._url=b(this._url,d,e)};a.prototype._sendUsingRestClient=function(g){try{var f=this._Send(g);var d=JSON.parse(f);if(!d){logError("Event_Hub_Transport::_sendUsingRestClient: Unable to parse result from transmission");return null}return d.statusCode}catch(h){logError("Event_Hub_Transport::_sendUsingRestClient: Exception caught with message: "+h.message)}};a.prototype._sendUsingXmlHttp=function(g){var f;try{var h=ModuleManager.create("xmlHttpComObj");if(!h.setup()){logError("Event_Hub_Transport::_sendUsingXmlHttp: couldnt create a xmlHttpCom");return null}f=h.getSelectedObjName();logInformation("Event_Hub_Transport::_sendUsingXmlHttp: Using "+f);h.open("POST",this._url,false);for(var j in this._requestHeaders){h.setRequestHeader(j,this._requestHeaders[j])}h.send(g);var l=h.getResponseHeader("Content-Type");var d=l.match("application/xml")?true:false;if(true===d){return"201"}var i="";try{i=h.getAllResponseHeaders();i=i.split("\r").join(" ");i=i.split("\n").join(" ")}catch(k){}this._reportExceptionTelemetry(f,"ResponseHeader:"+i,g);return null}catch(k){logError("Event_Hub_Transport::_sendUsingXmlHttp: Using COM obj ("+f+"). Exception caught with message: "+k.message);this._reportExceptionTelemetry(f,"ErrorMsg: "+k.message,g);return null}};a.prototype._sendUsingCommonHttpClient=function(d){try{var f=sendRequestInJSRT(this._url,this._requestHeaders,d);if(f===201){return f}else{logError("Event_Hub_Transport::_sendUsingCommonHttpClient: request failed with "+f+"status code");return null}}catch(g){logError("Event_Hub_Transport::_sendUsingCommonHttpClient. Exception caught with message: "+g.message);return null}};a.prototype._reportExceptionTelemetry=function(j,k,f){try{var d=ModuleManager.getSingleton("data_collector");if(!d.get("Device.Network.Connected")){logNormal("_reportExceptionTelemetry: No connection availble. Will not send");return}if(getScriptVariableStore().Get("sent.analytics_event_hub_transport_error")){return}getScriptVariableStore().Set("sent.analytics_event_hub_transport_error",true);var l=JSON.parse(f);var i=l.hit_uniqueid;var g={UniqueIdentifier:"analytics_event_hub_transport_error",type:"event",payload:{"Tracker.Type":"event",hit_category_0:"Analytics.Content",hit_category_1:"Exception",hit_action:"EventHub.Send.Fail",hit_label_0:j,hit_result:k,hit_label_1:i}};logNormal("Sending analytics_event_hub_transport_error event");var m=ModuleManager.getSingleton("event_handler");m.handleV1Record(g)}catch(h){logError("Event_Hub_Transport::_reportExceptionTelemetry: Exception caught with message"+h.message)}};a.prototype._sanitizeEventData=function(f){try{var h=JSON.parse(f);var d={};for(var g in h){d[g.toLowerCase()]=h[g]}return d}catch(i){logError("Event_Hub_Transport::_sanitizeEventData Exception caught with message: "+i.message);return null}};a.prototype.Send=function(i){try{var h=this._sanitizeEventData(i);var j=ModuleManager.getSingleton("mappings");var o=j._map(this._dictionary,h,false);var f=JSON.stringify(this._appendDottedKeys(o));logDebug("Event_Hub_Transport::Send: Sending using uri ("+this._url+")");var m=false;var d=0;var g=this._createSharedAccessToken(this._url,this._sharedAccessName,this._sharedAccessKey);this._AddRequestHeader("Content-Type","application/atom+xml;type=entry;charset=utf-8");this._AddRequestHeader("Authorization",g);this._AddRequestHeader("Host",this._servicebusNamespace+".servicebus.windows.net");var n={PartitionKey:engine.getContextId()};this._AddRequestHeader("BrokerProperties",JSON.stringify(n));if(this._usingRESTclientPlugin){d=this._sendUsingRestClient(f)}else{if(enableAnalyticsSDKForUWP){d=this._sendUsingCommonHttpClient(f)}else{d=this._sendUsingXmlHttp(f)}}logInformation("sendStatusCode: "+d);m=(d=="201")?true:false;if(!m){logError("Event_Hub_Transport.Send: Failed to send. Send status code: "+d)}var k=h.hit_event_id;if(this._usingRESTclientPlugin){this._transportLog(k,f,m)}else{this._transportLog(k,f,m,this.GetName()+"_xmlhttp")}return m}catch(l){logError("Event_Hub_Transport::Send: Exception caught when sending to ("+this._url+") with message: "+l.message);return false}return true};a.prototype._appendDottedKeys=function(f){var g=["csp_clientid","event_category","event_action","event_label","engagement_interactive","engagement_userinitiated","hit_type","hit_uniqueid","hit_severity","hit_label_1","hit_label_2","device_antimalware_provider_enabled","device_os_type","wss_istrial"];for(var e in g){var d=g[e];if(d in f){f[d.replace(/_/g,".")]=f[d]}}return f};a.prototype._createSharedAccessTokenParameters=function(i,k,p){try{if(!i||!k||!p){logError("Event_Hub_Transport::_createSharedAccessToken: Missing required parameter");return null}var n=encodeURIComponent(i);var f=new Date();var d=60*60*24*7;var g=Math.round(f.getTime()/1000)+d;var j=n+"\n"+g;var l=new jsSHA("SHA-256","TEXT");l.setHMACKey(p,"TEXT");l.update(j);var m=l.getHMAC("B64");var h={sr:n,sig:encodeURIComponent(m),se:g,skn:k};return h}catch(o){logError("Event_Hub_Transport::_createSharedAccessToken: Exception with message: "+o.message);return null}};a.prototype._tokenExpired=function(){try{if(!this._tokenCreationTime){return true}var f=new Date();var d=Math.abs(f-this._tokenCreationTime)/3600000;if(d>=this._tokenRefreshTime){this._tokenCreationTime=null;return true}}catch(g){logError("Event_Hub_Transport::_tokenExpired Exception caught with message: "+g.message)}return false};a.prototype._createSharedAccessToken=function(f,g,d){try{if(this._sharedAccessToken&&!this._tokenExpired()){return this._sharedAccessToken}logInformation("Event_Hub_Transport::_createSharedAccessToken: Shared access token expired or not availble. Recreating.");this._tokenCreationTime=new Date();var i=this._createSharedAccessTokenParameters(f,g,d);if(!i){logError("Event_Hub_Transport::_createSharedAccessToken creating token parameters failed");return null}this._sharedAccessToken="SharedAccessSignature sr="+i.sr+"&sig="+i.sig+"&se="+i.se+"&skn="+i.skn;return this._sharedAccessToken}catch(h){logError("Event_Hub_Transport::_createSharedAccessToken: Exception with message: "+h.message);return null}};var c=new a();return c}ModuleManager.registerFactory("transport_event_hub",CreateEventHubTransport);
//32BA30B5C78E0CFF09AF47E267BC7DEDE82491853B5894901014E2BB8CB66AFEC84DFC90019F59A288A1EB90FB8C7F14F3DFA0C1755BE2120411E4C78C0E81B3++